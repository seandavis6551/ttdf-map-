<script>
    var map, datasource, popup;

    map = new atlas.Map('map', {
      center: [-61.5, 10.5],
      zoom: 10,
      style: 'satellite_road_labels',
      authOptions: {
        authType: 'subscriptionKey',
        subscriptionKey: '3hKHJVvfOvlOgoSjetKsRIcbIwEF8zUe1VENCSmLB6w5BnijsIVjJQQJ99CBACYeBjFxYSSkAAAgAZMP4VAj'
      }
    });

    map.events.add('ready', function() {

      datasource = new atlas.source.DataSource();
      map.sources.add(datasource);

      var bubbleLayer = new atlas.layer.BubbleLayer(datasource, 'bubble-layer', {
        radius: 10,
        color: ['match', ['get', 'status'],
          'Active', '#00ff00',
          'Standby', '#ffff00',
          'Deployed', '#ff6600',
          '#00aaff'
        ],
        strokeColor: '#ffffff',
        strokeWidth: 2
      });

      var labelLayer = new atlas.layer.SymbolLayer(datasource, 'label-layer', {
        iconOptions: { image: 'none' },
        textOptions: {
          textField: ['get', 'label'],
          offset: [0, 1.8],
          color: '#ffffff',
          size: 11,
          haloColor: '#000000',
          haloWidth: 1
        }
      });

      map.layers.add([bubbleLayer, labelLayer]);

      popup = new atlas.Popup({ pixelOffset: [0, -15] });

      map.events.add('click', 'bubble-layer', function(e) {
        if (e.shapes && e.shapes.length > 0) {
          var props = e.shapes[0].getProperties();
          popup.setOptions({
            position: e.shapes[0].getCoordinates(),
            content:
              '<div style="background:#1a1a2e;color:#fff;padding:12px;border-radius:8px;' +
              'font-family:sans-serif;min-width:200px;border:1px solid #00aaff">' +
              '<div style="color:#00aaff;font-weight:bold;font-size:14px;margin-bottom:8px">ASSET DETAILS</div>' +
              '<b>Asset:</b> ' + props.assetUsed + '<br>' +
              '<b>Base:</b> ' + props.baseName + '<br>' +
              '<b>Ops Type:</b> ' + props.opsType + '<br>' +
              '<b>Category:</b> ' + props.opsCategory +
              '</div>'
          });
          popup.open(map);
        }
      });

      map.controls.add([
        new atlas.control.ZoomControl(),
        new atlas.control.CompassControl(),
        new atlas.control.StyleControl(),
        new atlas.control.FullscreenControl()
      ], { position: 'top-right' });

      document.getElementById('status').innerText = 'Loading asset data...';
      fetchAssets();
      setInterval(fetchAssets, 30000);
    });

    async function fetchAssets() {
      try {
        var tokenResponse = await fetch('/.auth/me');
        var tokenData = await tokenResponse.json();
        var token = tokenData[0].access_token;

        var graphUrl = "https://graph.microsoft.com/v1.0/sites/solaris6551.sharepoint.com:/sites/SolarisSecurityOperationsHub:/lists/Joint%20Operations%20Activity%20Log/items?expand=fields&$top=100";

        var response = await fetch(graphUrl, {
          headers: {
            'Authorization': 'Bearer ' + token
          }
        });

        var data = await response.json();
        var assets = data.value.map(function(item) {
          return item.fields;
        });
        updateMarkers(assets);

      } catch(err) {
        document.getElementById('status').innerText = 'Error: ' + err.message;
      }
    }

    function updateMarkers(assetData) {
      datasource.clear();
      if (popup) popup.close();
      var count = 0;
      assetData.forEach(function(a) {
        var lat = parseFloat(a.Latitude);
        var lng = parseFloat(a.Longitude);
        if (!isNaN(lat) && !isNaN(lng)) {
          datasource.add(new atlas.data.Feature(
            new atlas.data.Point([lng, lat]), {
              label: a.Asset_x0020_Used || a['Asset Used'] || 'Asset',
              assetUsed: a.Asset_x0020_Used || a['Asset Used'] || 'Unknown',
              baseName: a.Base_x0020_Name || a['Base Name'] || 'Unknown',
              opsType: a.Operations_x0020_Type || a['Operations Type'] || 'Unknown',
              opsCategory: a.Operations_x0020_Category || a['Operations Category'] || 'Unknown'
            }
          ));
          count++;
        }
      });
      var now = new Date().toLocaleTimeString();
      document.getElementById('status').innerText =
        'Assets tracked: ' + count + ' | Last update: ' + now;
    }
  </script>
